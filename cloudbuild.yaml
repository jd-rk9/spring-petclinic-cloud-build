# cloudbuild.yaml
steps:
# 1. Build and push the container image using Spring Boot's build-image goal
- name: 'maven:3.9-eclipse-temurin-17'
  dir: '.' # Explicitly set the working directory to the project root
  entrypoint: './mvnw'
  args:
    - 'spring-boot:build-image'
    - '-DskipTests'
    - '-Dspring-boot.build-image.imageName=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/petclinic:$SHORT_SHA'
    - '-Dspring-boot.build-image.publish=true'
  # The build-image goal requires access to a Docker daemon.
  # We enable it for this step using the Cloud Build Docker-in-Docker service.
  env: ['DOCKER_HOST=tcp://127.0.0.1:2375']

# 4. (Optional but recommended) Deploy to GKE
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
  - 'container'
  - 'clusters'
  - 'get-credentials'
  - 'gorilla-clinic-cluster'
  - '--region'
  - '${_GKE_REGION}'
- name: 'gcr.io/cloud-builders/kubectl'
  args:
  - 'set'
  - 'image'
  - 'deployment/petclinic' # Assumes a deployment named 'petclinic'
  - 'petclinic-app=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/petclinic:$SHORT_SHA'
  env:
  - 'CLOUDSDK_COMPUTE_REGION=${_GKE_REGION}'

substitutions:
  _AR_HOST: '${_GCP_REGION}-docker.pkg.dev'
  _REPO_NAME: 'gorilla-clinic-repo'
  _GCP_REGION: 'europe-west4' # Your region
  _GKE_REGION: 'europe-west4' # Your region

images:
- '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/petclinic:$SHORT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY
